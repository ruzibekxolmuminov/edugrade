<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>EDUGRADE.UZ - Chat & Portal</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,FILL@0..1&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#137fec", "background-light": "#f6f7f8", "background-dark": "#101922" },
                    fontFamily: { "display": ["Lexend", "sans-serif"], "body": ["Inter", "sans-serif"] }
                }
            }
        }
    </script>
    <style>
        .hidden { display: none !important; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cfd9e7; border-radius: 10px; }
    </style>
</head>
<body class="font-body bg-background-light dark:bg-background-dark text-[#111418] dark:text-white transition-colors duration-200 h-screen overflow-hidden">

<div id="login-section" class="min-h-screen flex w-full">
    <div class="hidden lg:flex w-1/2 relative bg-primary/10 items-center justify-center overflow-hidden">
        <div class="absolute inset-0 z-0 bg-cover bg-center" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuAase13BfX4vJDxyXEJMpzHKg1j2fLbgsy_Zch6rppXvNvI53St8u5bG27HBeIgv1L1dgUUXNa8YmEeS5L0tx4WZ22y79lV66oNkpRGUQ_VQ-ReqmHvUz8JQwbKPk7CgQYp_-BtC993V9eWg46e4TAOE7dGRqvCNFpi27sG4cgnSdSaXYDw2hLMqgL6l3hxpYH0htY6PTIeaiaQxk_yiP7SHxEfW-9WUy8CYTE_wujMPaAPITohTISASwyjtxQxxCOvzLTDP9DLROg');"></div>
        <div class="absolute inset-0 bg-primary/80 mix-blend-multiply"></div>
        <div class="relative z-10 p-12 text-white max-w-xl">
            <h2 class="text-4xl font-bold mb-4">Empowering Education</h2>
            <p class="text-lg opacity-90">Manage grades, attendance, and chat with your class in real-time.</p>
        </div>
    </div>
    <div class="w-full lg:w-1/2 flex flex-col bg-white dark:bg-background-dark justify-center items-center px-12">
        <div class="w-full max-w-[400px] space-y-6">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-primary">EDUGRADE.UZ</h1>
                <p class="text-slate-500 mt-2">Login to access your classes</p>
            </div>
            <div class="space-y-4">
                <input id="login-passport" type="text" placeholder="Passport Number (e.g. 623)" class="w-full h-12 rounded-lg border border-slate-300 dark:bg-slate-800 px-4 focus:ring-2 focus:ring-primary">
                <input id="login-password" type="password" placeholder="Password" class="w-full h-12 rounded-lg border border-slate-300 dark:bg-slate-800 px-4 focus:ring-2 focus:ring-primary">
                <button onclick="handleLogin()" id="login-btn" class="w-full h-12 bg-primary text-white font-bold rounded-lg shadow-lg hover:bg-blue-600 transition-all flex items-center justify-center gap-2">
                    Login <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="chat-section" class="hidden h-screen flex w-full overflow-hidden">
    <aside class="w-[280px] bg-white dark:bg-[#1a2634] border-r border-[#cfd9e7] dark:border-gray-700 flex flex-col h-full">
        <div class="p-6 border-b dark:border-gray-700 flex items-center gap-3">
            <div id="user-avatar" class="size-10 rounded-full bg-primary flex items-center justify-center text-white font-bold">A</div>
            <div class="overflow-hidden">
                <p id="user-fullname" class="text-sm font-bold truncate">User Name</p>
                <p id="user-role" class="text-[10px] text-gray-500 uppercase tracking-widest">Student</p>
            </div>
        </div>
        <div id="group-list" class="flex-1 overflow-y-auto scrollbar-thin p-2 space-y-1">
            <div class="p-4 text-center text-gray-400 text-xs">Guruhlar yuklanmoqda...</div>
        </div>
        <button onclick="logout()" class="p-4 text-red-500 text-sm font-bold border-t dark:border-gray-700 flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">logout</span> Logout
        </button>
    </aside>

    <main class="flex-1 flex flex-col bg-background-light dark:bg-background-dark">
        <header class="h-16 bg-white dark:bg-[#1a2634] border-b dark:border-gray-700 px-6 flex items-center justify-between">
            <h3 id="active-group-name" class="font-bold text-lg">Select a group</h3>
        </header>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 scrollbar-thin">
        </div>
        <div class="p-4 bg-white dark:bg-[#1a2634] border-t dark:border-gray-700">
            <div class="flex gap-2">
                <input id="msg-input" type="text" placeholder="Xabar yozing..." class="flex-1 bg-gray-100 dark:bg-slate-800 border-none rounded-lg focus:ring-2 focus:ring-primary">
                <button onclick="sendMessage()" class="bg-primary text-white p-3 rounded-lg flex items-center justify-center">
                    <span class="material-symbols-outlined">send</span>
                </button>
            </div>
        </div>
    </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    let stompClient = null;
    let currentUser = null;
    let activeGroupId = null;
    let currentSubscription = null;

    // 1. LOGIN FUNKSIYASI
    async function handleLogin() {
        const passportNumber = document.getElementById('login-passport').value;
        const password = document.getElementById('login-password').value;
        const btn = document.getElementById('login-btn');

        btn.disabled = true;
        btn.innerHTML = "Checking...";

        try {
            const response = await fetch('http://localhost:8080/v1/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ passportNumber, password })
            });

            if (response.ok) {
                const data = await response.json();
                currentUser = data;
                localStorage.setItem('user', JSON.stringify(data));
                initApp();
            } else {
                alert("Login xato! Ma'lumotlarni tekshiring.");
            }
        } catch (err) {
            console.error(err);
            alert("Serverga ulanib bo'lmadi.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = "Login to Dashboard";
        }
    }

    // 2. APP INIZIALIZATSIYA
    function initApp() {
        if (!currentUser) return;

        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('chat-section').classList.remove('hidden');

        document.getElementById('user-fullname').innerText = `${currentUser.firstName} ${currentUser.lastName}`;
        document.getElementById('user-role').innerText = currentUser.roles[0].replace('ROLE_', '');
        document.getElementById('user-avatar').innerText = currentUser.firstName[0].toUpperCase();

        connectWS();
        fetchUserGroups();
    }

    // 3. WS ULANISH
    function connectWS() {
        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({ 'Authorization': 'Bearer ' + currentUser.jwt }, (frame) => {
            console.log('Connected: ' + frame);
        });
    }

    // 4. GURUHLARNI YUKLASH (Guruhlarni sizning schoolId yoki alohida API dan olamiz)
    async function fetchUserGroups() {
        const groupList = document.getElementById('group-list');
        groupList.innerHTML = '<div class="p-4 text-center text-gray-400 text-xs">Yuklanmoqda...</div>';

        try {
            const response = await fetch('http://localhost:8080/api/v1/chat/my-groups', {
                headers: {
                    'Authorization': 'Bearer ' + currentUser.jwt,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const groups = await response.json();
                groupList.innerHTML = '';

                if (groups.length === 0) {
                    groupList.innerHTML = '<div class="p-4 text-center text-xs">Sizda guruhlar yo\'q</div>';
                    return;
                }

                groups.forEach(g => {
                    const div = document.createElement('div');
                    div.className = "group-item p-3 rounded-lg hover:bg-primary/10 cursor-pointer transition-all border border-transparent mb-1";
                    div.id = `group-item-${g.id}`;

                    // Agar backenddan memberCount kelmasa, 0 deb olamiz
                    const mCount = g.memberCount || 0;

                    div.innerHTML = `
                    <p class="font-bold text-sm text-[#0d131b] dark:text-white">${g.name}</p>
                    <p class="text-[10px] text-gray-500 italic">${mCount} ta a'zo</p>
                `;

                    // BU YERDA: selectGroup ga 3-argumentni (mCount) qo'shdik
                    div.onclick = () => selectGroup(g.id, g.name, mCount);
                    groupList.appendChild(div);
                });
            }
        } catch (err) {
            console.error("Guruhlarni yuklashda xato:", err);
            groupList.innerHTML = '<div class="p-4 text-center text-red-500 text-xs">Xatolik yuz berdi</div>';
        }
    }

    // 5. GURUHNI TANLASH
    async function selectGroup(id, name, count) {
        activeGroupId = id;

        // count ni xavfsiz holatga keltirish (agar kelmasa 0 bo'ladi)
        const displayCount = count || 0;

        document.getElementById('active-group-name').innerHTML = `
        <div class="flex flex-col">
            <span class="font-bold text-lg leading-tight">${name}</span>
            <span class="text-xs text-gray-500 font-normal">${displayCount} ta a'zo</span>
        </div>
    `;

        // Tanlangan guruhni vizual ajratish
        document.querySelectorAll('.group-item').forEach(el => {
            el.classList.remove('bg-primary/20', 'border-primary/30');
        });
        const selectedEl = document.getElementById(`group-item-${id}`);
        if (selectedEl) {
            selectedEl.classList.add('bg-primary/20', 'border-primary/30');
        }

        await loadChatHistory(id);

        if (currentSubscription) currentSubscription.unsubscribe();
        currentSubscription = stompClient.subscribe('/topic/group.' + id, (message) => {
            renderMessage(JSON.parse(message.body));
        });
    }

    async function loadChatHistory(groupId) {
        const container = document.getElementById('chat-messages');
        container.innerHTML = '<div class="text-center text-xs text-gray-400">Tarix yuklanmoqda...</div>';

        try {
            const response = await fetch(`http://localhost:8080/v1/chat/history/${groupId}`, {
                headers: {
                    'Authorization': 'Bearer ' + currentUser.jwt,
                }
            });

            if (response.ok) {
                const messages = await response.json();
                container.innerHTML = ''; // "Loading"ni o'chirish

                if (messages.length === 0) {
                    container.innerHTML = '<div class="text-center text-xs text-gray-400">Hozircha xabarlar yo\'q</div>';
                } else {
                    messages.forEach(msg => renderMessage(msg));
                }
            }
        } catch (err) {
            console.error("Tarixni yuklashda xato:", err);
            container.innerHTML = '<div class="text-center text-xs text-red-400">Tarixni yuklab bo\'lmadi</div>';
        }
    }


    // 7. XABAR YUBORISH
    // 7. XABAR YUBORISH (TUZATILDI)
    function sendMessage() {
        const input = document.getElementById('msg-input');
        const content = input.value.trim();
        if (!content || !activeGroupId) return;

        const payload = {
            // MUHIM: passportNumber emas, login response'dan kelgan UUID (id) ni yuboramiz
            senderId: currentUser.id,
            groupId: activeGroupId,
            content: content,
            type: 'CHAT',
            senderName: currentUser.firstName + " " + currentUser.lastName
        };

        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(payload));
        input.value = '';
    }

    // 6. XABARNI EKRANGA CHIQARISH (isMe tekshiruvi UUID orqali)
    function renderMessage(msg) {
        const container = document.getElementById('chat-messages');
        const isMe = msg.senderId === currentUser.id;

        // Vaqtni formatlash (ISO datadan faqat HH:mm qismini olish)
        const date = msg.createdAt ? new Date(msg.createdAt) : new Date();
        const timeStr = date.getHours().toString().padStart(2, '0') + ':' +
            date.getMinutes().toString().padStart(2, '0');

        const html = `
    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-2">
        <span class="text-[10px] text-gray-500 mb-1 px-1">
            ${isMe ? 'Siz' : (msg.senderName || 'User')}
        </span>
        <div class="relative ${isMe ? 'bg-primary text-white rounded-tr-none' : 'bg-white dark:bg-slate-800 text-current border border-gray-200 dark:border-gray-700 rounded-tl-none'} px-4 py-2 pb-5 rounded-2xl shadow-sm max-w-[80%] text-sm">
            ${msg.content}
            <span class="absolute bottom-1 right-2 text-[9px] ${isMe ? 'text-blue-100' : 'text-gray-400'}">
                ${timeStr}
            </span>
        </div>
    </div>`;

        container.insertAdjacentHTML('beforeend', html);
        container.scrollTop = container.scrollHeight;
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }

    // Enter bosilganda yuborish
    document.getElementById('msg-input')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
</script>
</body>
</html>